<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 32px;
        }

        header p {
            color: #666;
            font-size: 14px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .secondary {
            background: #6c757d;
        }

        .danger {
            background: #dc3545;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-box .number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-box .label {
            font-size: 14px;
            opacity: 0.9;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table thead {
            background: #f8f9fa;
        }

        table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #dee2e6;
        }

        table td {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            color: #666;
        }

        table tbody tr:hover {
            background: #f8f9fa;
        }

        table tbody tr:last-child td {
            border-bottom: none;
        }

        .empty {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty svg {
            width: 60px;
            height: 60px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            background: #e9ecef;
            color: #495057;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .footer {
            text-align: center;
            color: white;
            margin-top: 30px;
            font-size: 12px;
            opacity: 0.8;
        }

        @media (max-width: 768px) {
            header {
                padding: 20px;
            }

            header h1 {
                font-size: 24px;
            }

            .card {
                padding: 20px;
            }

            table {
                font-size: 12px;
            }

            table th, table td {
                padding: 10px;
            }

            .controls {
                flex-direction: column;
            }

            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Database Dashboard</h1>
            <p>Kelola dan pantau data user aplikasi cinema Anda</p>
            <div class="controls">
                <button onclick="fetchData()">üîÑ Refresh Data</button>
                <button class="secondary" onclick="exportData()">üì• Export CSV</button>
                <button class="danger" onclick="clearDatabase()">üóëÔ∏è Clear Database</button>
            </div>
        </header>

        <div class="card">
            <div id="message" class="message"></div>

            <h2>üìà Statistik</h2>
            <div class="stats">
                <div class="stat-box">
                    <div class="number" id="totalUsers">0</div>
                    <div class="label">Total Users</div>
                </div>
                <div class="stat-box">
                    <div class="number" id="totalMovies">0</div>
                    <div class="label">Total Movies</div>
                </div>
                <div class="stat-box">
                    <div class="number" id="totalScreenings">0</div>
                    <div class="label">Total Screenings</div>
                </div>
                <div class="stat-box">
                    <div class="number" id="totalBookings">0</div>
                    <div class="label">Total Bookings</div>
                </div>
                <div class="stat-box">
                    <div class="number" id="totalRevenue">0</div>
                    <div class="label">Revenue (IDR)</div>
                </div>
                <div class="stat-box">
                    <div class="number" id="lastUpdate">-</div>
                    <div class="label">Last Update</div>
                </div>
            </div>

            <h2>üë• Data User</h2>
            <div id="loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Loading data...</p>
            </div>
            <div id="tableContainer"></div>
        </div>

        <div class="footer">
            <p>Last refreshed: <span id="refreshTime">-</span></p>
        </div>
    </div>

    <script>
        const API_URL = '/api/admin/summary';

        async function fetchData() {
            const loadingDiv = document.getElementById('loading');
            const tableContainer = document.getElementById('tableContainer');
            const messageDiv = document.getElementById('message');

            loadingDiv.style.display = 'block';
            tableContainer.innerHTML = '';
            messageDiv.className = 'message';
            messageDiv.innerHTML = '';

            try {
                const response = await fetch(API_URL);
                const data = await response.json();

                if (response.ok) {
                    displayData(data);
                    showMessage('‚úÖ Data berhasil dimuat', 'success');
                } else {
                    showMessage('‚ùå ' + data.error, 'error');
                }
            } catch (error) {
                // If admin summary fails (server route not ready), try fallback to existing check-db endpoint
                try {
                    const fallbackRes = await fetch('/api/auth/check-db');
                    const fallbackData = await fallbackRes.json();
                    if (fallbackRes.ok) {
                        // Map fallback to minimal admin-like shape
                        const mapped = {
                            timestamp: fallbackData.timestamp || new Date().toISOString(),
                            totals: { users: fallbackData.total_users || 0, movies: 0, screenings: 0, bookings: 0, revenue: 0 },
                            users: fallbackData.users || [],
                            movies: [], screenings: [], auditoriums: [], seats: [], bookings: [], tickets: [], payments: [], seat_locks: [], promotions: []
                        };
                        displayData(mapped);
                        showMessage('‚ÑπÔ∏è Admin summary failed, loaded user data from check-db', 'success');
                    } else {
                        showMessage('‚ùå Failed to fetch admin summary', 'error');
                    }
                } catch (fallbackErr) {
                    showMessage('‚ùå Failed to fetch admin summary', 'error');
                    console.error('Summary fetch error and fallback failed:', error, fallbackErr);
                }
            } finally {
                loadingDiv.style.display = 'none';
                updateRefreshTime();
            }
        }

        function displayData(data) {
            const tableContainer = document.getElementById('tableContainer');

            const totals = data.totals || {};
            document.getElementById('totalUsers').textContent = totals.users || 0;
            document.getElementById('totalMovies').textContent = totals.movies || 0;
            document.getElementById('totalScreenings').textContent = totals.screenings || 0;
            document.getElementById('totalBookings').textContent = totals.bookings || 0;
            document.getElementById('totalRevenue').textContent = Intl.NumberFormat('id-ID').format(totals.revenue || 0);
            document.getElementById('lastUpdate').textContent = new Date(data.timestamp).toLocaleString('id-ID');

            // store columns per-section for export
            window._columnsMap = window._columnsMap || {};

            function renderTable(title, key, columns, rows) {
                // save columns map for export
                window._columnsMap[key] = columns;

                if (!rows || rows.length === 0) {
                    return `
                        <div class="card">
                            <h2>${title}</h2>
                            <div style="margin-top:8px"><button class="secondary" onclick="exportTable('${key}')">üì• Export CSV</button></div>
                            <div class="empty">Tidak ada data</div>
                        </div>
                    `;
                }

                let html = `
                    <div class="card">
                        <h2>${title}</h2>
                        <div style="margin-top:8px"><button class="secondary" onclick="exportTable('${key}')">üì• Export CSV</button></div>
                        <table>
                            <thead>
                                <tr>`;
                columns.forEach(col => { html += `<th>${col.label}</th>`; });
                html += `</tr>
                            </thead>
                            <tbody>`;

                rows.forEach(r => {
                    html += '<tr>';
                    columns.forEach(col => {
                        const val = col.render ? col.render(r) : (r[col.key] ?? '-');
                        html += `<td>${val}</td>`;
                    });
                    html += '</tr>';
                });

                html += `</tbody></table></div>`;
                return html;
            }

            // save last fetched data for exports and actions
            window._adminData = data;

            // Compose sections
            let out = '';

            // Users
            out += renderTable('üë• Users', 'users', [
                { key: 'id', label: 'ID' },
                { key: 'email', label: 'Email' },
                { key: 'full_name', label: 'Nama' },
                { key: 'phone_number', label: 'Telepon' },
                { key: 'created_at', label: 'Terdaftar', render: (r) => new Date(r.created_at).toLocaleString('id-ID') }
            ], data.users);

            // Bookings (placeholder ‚Äî paginated)
            out += `
                <div class="card" id="bookings-section">
                    <h2>üéüÔ∏è Bookings</h2>
                    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;" id="bookings-controls">
                        <label>From: <input type="date" id="bookings-from"></label>
                        <label>To: <input type="date" id="bookings-to"></label>
                        <label>Status: <input id="bookings-status" placeholder="pending/confirmed/cancelled"></label>
                        <button class="secondary" onclick="loadBookingsPage(1)">Apply</button>
                        <button class="secondary" onclick="exportTable('bookings')">üì• Export CSV</button>
                    </div>
                    <div id="bookings-table">Memuat bookings...</div>
                </div>
            `;

            // Payments (placeholder ‚Äî paginated)
            out += `
                <div class="card" id="payments-section">
                    <h2>üí≥ Payments</h2>
                    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;" id="payments-controls">
                        <label>From: <input type="date" id="payments-from"></label>
                        <label>To: <input type="date" id="payments-to"></label>
                        <label>Status: <input id="payments-status" placeholder="pending/paid/failed"></label>
                        <button class="secondary" onclick="loadPaymentsPage(1)">Apply</button>
                        <button class="secondary" onclick="exportTable('payments')">üì• Export CSV</button>
                    </div>
                    <div id="payments-table">Memuat payments...</div>
                </div>
            `;

            // Screenings
            out += renderTable('üé¨ Screenings', 'screenings', [
                { key: 'id', label: 'ID' },
                { key: 'movie_id', label: 'Movie ID' },
                { key: 'auditorium_id', label: 'Auditorium' },
                { key: 'start_time', label: 'Start' },
                { key: 'base_price', label: 'Price' }
            ], data.screenings);

            // Seat Locks
            out += renderTable('üîí Seat Locks', 'seat_locks', [
                { key: 'id', label: 'ID' },
                { key: 'screening_id', label: 'Screening ID' },
                { key: 'seat_id', label: 'Seat ID' },
                { key: 'locked_by', label: 'Locked By' },
                { key: 'expires_at', label: 'Expires At' },
                { key: 'actions', label: 'Actions', render: (r) => `<button class=\"secondary\" onclick=\"releaseLock(${r.id})\">Release</button>` }
            ], data.seat_locks);

            // Movies (small)
            out += renderTable('üéûÔ∏è Movies', 'movies', [
                { key: 'id', label: 'ID' },
                { key: 'title', label: 'Title' },
                { key: 'duration_minutes', label: 'Duration' },
                { key: 'genre', label: 'Genre' }
            ], data.movies);

            tableContainer.innerHTML = out;

            // Load first pages for paginated sections
            setTimeout(() => {
                try { loadBookingsPage(1); } catch (e) { /* ignore */ }
                try { loadPaymentsPage(1); } catch (e) { /* ignore */ }
            }, 50);
        }

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
            setTimeout(() => {
                messageDiv.className = 'message';
            }, 5000);
        }

        // Release a seat lock by id (calls DELETE endpoint)
        async function releaseLock(id) {
            if (!confirm('Release seat lock #' + id + '?')) return;
            try {
                const res = await fetch('/api/admin/seat-locks/' + id, { method: 'DELETE' });
                const data = await res.json();
                if (res.ok && data.success) {
                    showMessage('‚úÖ Lock released', 'success');
                    fetchData();
                } else {
                    showMessage('‚ùå ' + (data.error || 'Gagal melepaskan lock'), 'error');
                }
            } catch (err) {
                showMessage('‚ùå Error: ' + err.message, 'error');
            }
        }

        // Export a specific table (by key) to CSV using stored admin data and columns map
        function exportTable(key) {
            // support paginated sections which store last page data separately
            const data = (key === 'bookings') ? window._bookingsLastPageData : (key === 'payments') ? window._paymentsLastPageData : (window._adminData && window._adminData[key]);
            const columns = window._columnsMap && window._columnsMap[key];
            if (!data || !columns) {
                alert('Tidak ada data untuk diexport');
                return;
            }

            // build csv header from columns (skip actions)
            const header = columns.filter(c => c.key !== 'actions').map(c => c.label.replace(/\n/g, ' '));
            let csv = header.join(',') + '\n';

            data.forEach(row => {
                const vals = columns.filter(c => c.key !== 'actions').map(c => {
                    const v = c.render ? (c.render(row) + '') : (row[c.key] ?? '');
                    // strip HTML if any
                    return '"' + (v + '').replace(/"/g, '""').replace(/<[^>]*>/g, '') + '"';
                });
                csv += vals.join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cinema-${key}-${new Date().toISOString().slice(0, 10)}.csv`;
            a.click();
            showMessage('‚úÖ Export berhasil', 'success');
        }

        // --- Bookings pagination & rendering ---
        async function loadBookingsPage(page = 1) {
            const from = document.getElementById('bookings-from').value || '';
            const to = document.getElementById('bookings-to').value || '';
            const status = document.getElementById('bookings-status').value || '';
            const pageSize = 10;
            const tableDiv = document.getElementById('bookings-table');
            tableDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Memuat bookings...</p></div>';

            const q = new URLSearchParams({ page, pageSize, ...(status ? { status } : {}), ...(from ? { from } : {}), ...(to ? { to } : {}) });
            try {
                const res = await fetch('/api/admin/bookings?' + q.toString());
                const j = await res.json();
                if (!res.ok) {
                    tableDiv.innerHTML = `<div class="empty">Error: ${j.error}</div>`;
                    return;
                }
                window._bookingsLastPageData = j.data || [];
                renderBookingsTable(j);
            } catch (err) {
                tableDiv.innerHTML = `<div class="empty">Error: ${err.message}</div>`;
            }
        }

        function renderBookingsTable(pageData) {
            const rows = pageData.data || [];
            const tableDiv = document.getElementById('bookings-table');
            if (!rows.length) {
                tableDiv.innerHTML = '<div class="empty">Tidak ada bookings</div>';
                return;
            }

            let html = '<table><thead><tr><th>ID</th><th>User ID</th><th>Screening</th><th>Status</th><th>Amount</th><th>Tanggal</th></tr></thead><tbody>';
            rows.forEach(r => {
                html += `<tr><td>#${r.id}</td><td>${r.user_id || '-'}</td><td>${r.screening_id}</td><td>${r.status}</td><td>${Intl.NumberFormat('id-ID').format(r.total_amount || 0)}</td><td>${r.created_at ? new Date(r.created_at).toLocaleString('id-ID') : '-'}</td></tr>`;
            });
            html += '</tbody></table>';

            // pagination
            html += `<div style="display:flex; gap:8px; align-items:center; margin-top:10px;"><button class="secondary" ${pageData.page<=1? 'disabled':''} onclick="loadBookingsPage(${pageData.page-1})">Prev</button><span>Page ${pageData.page} / ${pageData.totalPages}</span><button class="secondary" ${pageData.page>=pageData.totalPages? 'disabled':''} onclick="loadBookingsPage(${pageData.page+1})">Next</button></div>`;

            tableDiv.innerHTML = html;
        }

        // --- Payments pagination & rendering ---
        async function loadPaymentsPage(page = 1) {
            const from = document.getElementById('payments-from').value || '';
            const to = document.getElementById('payments-to').value || '';
            const status = document.getElementById('payments-status').value || '';
            const pageSize = 10;
            const tableDiv = document.getElementById('payments-table');
            tableDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Memuat payments...</p></div>';

            const q = new URLSearchParams({ page, pageSize, ...(status ? { status } : {}), ...(from ? { from } : {}), ...(to ? { to } : {}) });
            try {
                const res = await fetch('/api/admin/payments?' + q.toString());
                const j = await res.json();
                if (!res.ok) {
                    tableDiv.innerHTML = `<div class="empty">Error: ${j.error}</div>`;
                    return;
                }
                window._paymentsLastPageData = j.data || [];
                renderPaymentsTable(j);
            } catch (err) {
                tableDiv.innerHTML = `<div class="empty">Error: ${err.message}</div>`;
            }
        }

        function renderPaymentsTable(pageData) {
            const rows = pageData.data || [];
            const tableDiv = document.getElementById('payments-table');
            if (!rows.length) {
                tableDiv.innerHTML = '<div class="empty">Tidak ada payments</div>';
                return;
            }

            let html = '<table><thead><tr><th>ID</th><th>Booking ID</th><th>Provider</th><th>Amount</th><th>Status</th><th>Paid At</th></tr></thead><tbody>';
            rows.forEach(r => {
                html += `<tr><td>#${r.id}</td><td>${r.booking_id}</td><td>${r.provider || '-'}</td><td>${Intl.NumberFormat('id-ID').format(r.amount || 0)}</td><td>${r.status}</td><td>${r.paid_at ? new Date(r.paid_at).toLocaleString('id-ID') : '-'}</td></tr>`;
            });
            html += '</tbody></table>';

            html += `<div style="display:flex; gap:8px; align-items:center; margin-top:10px;"><button class="secondary" ${pageData.page<=1? 'disabled':''} onclick="loadPaymentsPage(${pageData.page-1})">Prev</button><span>Page ${pageData.page} / ${pageData.totalPages}</span><button class="secondary" ${pageData.page>=pageData.totalPages? 'disabled':''} onclick="loadPaymentsPage(${pageData.page+1})">Next</button></div>`;

            tableDiv.innerHTML = html;
        }

        function exportData() {
            fetch(API_URL)
                .then(res => res.json())
                .then(data => {
                    if (data.users.length === 0) {
                        alert('Tidak ada data untuk diexport');
                        return;
                    }

                    let csv = 'ID,Email,Nama Lengkap,No. Telepon,Terdaftar\n';
                    data.users.forEach(user => {
                        csv += `${user.id},"${user.email}","${user.full_name}","${user.phone_number || '-'}","${user.created_at}"\n`;
                    });

                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `cinema-users-${new Date().toISOString().slice(0, 10)}.csv`;
                    a.click();
                    showMessage('‚úÖ Export berhasil', 'success');
                })
                .catch(err => showMessage('‚ùå Error: ' + err.message, 'error'));
        }

        function clearDatabase() {
            if (!confirm('‚ö†Ô∏è Apakah Anda yakin ingin menghapus semua data user? Tindakan ini tidak dapat dibatalkan!')) {
                return;
            }

            fetch('/api/auth/clear-db', { method: 'DELETE' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showMessage('‚úÖ Database berhasil dihapus', 'success');
                        setTimeout(() => fetchData(), 1000);
                    } else {
                        showMessage('‚ùå ' + data.error, 'error');
                    }
                })
                .catch(err => showMessage('‚ùå Error: ' + err.message, 'error'));
        }

        function updateRefreshTime() {
            const now = new Date().toLocaleTimeString('id-ID');
            document.getElementById('refreshTime').textContent = now;
        }

        // Load data on page load
        window.addEventListener('load', fetchData);

        // Auto-refresh every 5 minutes
        setInterval(fetchData, 5 * 60 * 1000);
    </script>
</body>
</html>
